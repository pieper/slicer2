<title>This Web Site</title>
<pre>
April 22, 2000  gering@ai.mit.edu
--------------------------------------------------------------------------
This file lists everything you need to know to administer the web servers
on this machine (scooby.ai.mit.edu). 

If you're wondering why I chose AOLserver as the web server, then read:
http://photo.net/wtr/aolserver/introduction-1.html

And if you're wondering why I chose Oracle, then read:
http://photo.net/wtr/aolserver/introduction-2.html

If you're thinking, "But wait, I don't understand web servers or relational
databases, or SQL!", then see the problem set at
http://photo.net/teaching/psets/ps1/ps1.adp
  
Now the good stuff:


1.) How to update the content at www.slicer.org
--------------------------------------------------------------------------
Run this script: /scratch/update

which does this (order matters):
cd /scratch/web
cvs update -d
cd /scratch/pkg/slicer2
cvs update
cd /scratch/pkg/slicer2/Scripts
./document

The call to cvs update in /scratch/web is to ensure that all needed 
directories have been created before the documentation is generated.

The SLICER_DOC environment variable is set to /scratch/web so that when
the document script is run, it will place the output html pages in the
directories that the web server displays to the rest of the world.

2.) How To Restart the web server:
--------------------------------------------------------------------------
Type: $NS_HOME/slicer/kill


3.) How To View the error log
--------------------------------------------------------------------------
Type: less $NS_HOME/slicer/log/server.log
Then use the ">" key to jump to the end of the log, and the "f" and "b"
keys to page forward and backwards through the log.


4.) How to interact with the oracle database:
--------------------------------------------------------------------------
Run "sqlplus" with user-name "SYSTEM" and password "manager".
Then you receive a prompt from which you can type SQL commands.
For SQL lessons, see http://photo.net/sql


5.) How To Restart the oracle database:
--------------------------------------------------------------------------
You need to do this if you can't connect to the database using sqlplus.

[oracle8i@scooby /scratch]$ sqlplus /nolog

SQL*Plus: Release 8.1.5.0.0 - Production on Mon Apr 3 11:21:50 2000

(c) Copyright 1999 Oracle Corporation.  All rights reserved.

SQL> connect / as sysdba
Connected to an idle instance.
SQL> startup
ORACLE instance started.

Total System Global Area  107388304 bytes
Fixed Size                    64912 bytes
Variable Size              90374144 bytes
Database Buffers           16777216 bytes
Redo Buffers                 172032 bytes
Database mounted.
Database opened.
SQL> exit
Disconnected from Oracle8i Enterprise Edition Release 8.1.5.0.2 - Production
With the Partitioning and Java options
PL/SQL Release 8.1.5.0.0 - Production
[oracle8i@scooby /scratch]$ 


6.) How I have guaranteed uptime (almost):
--------------------------------------------------------------------------
a.) Monitoring by the Operating System

There is a Linux process named "init" that restarts a process whenever it
dies.  I told it to monitor our web servers by editing the /etc/initab file
as described in the later on this page.

b.) Monitoring by another Web Server process

One of the webservers running on this machine is called "keepalive" and
was downloaded from http://www.arsdigita.com/download/index.tcl.
This server tests the other servers every 60 seconds, and if it fails
to connect after a certain number of tries, it kills the server and
emails the sysadmin.  Note that when the server is killed, it is automatically
restarted by "init".  You can edit the keepalive settings in 
$NS_HOME/keepalive/modules/init.tcl

c.) Monitoring by another Machine

Another machine tries to connect to this web server every 15 minutes,
and emails my mobile phone on failure.  This is achieved by registering
with the free service called "uptime" at:
http://uptime.arsdigita.com/uptime/about.tcl


7.) How this entire database-backed web site was installed:
--------------------------------------------------------------------------
a.) Install oracle and create a starter database following the directions from:
    "User Friendly Install Of Oracle8i on Redhat Linux 6.1" located at
    http://technet.oracle.com/tech/linux/ 
    Edit .bash_profile to setup the environment as described later (below).
b.) Download source distribution from www.aolserver.com into /scratch/pkg
c.) Compile aolserver following the README, which installs it into /tmp/aolserver
d.) When satisfied, move the installation from /tmp/aolserver to $NS_HOME
e.) Download the oracle driver into /scratch/pkg from:
    http://www.arsdigita.com/free-tools/oracle-driver.html
    Carefull, it untars into a directory named oracle, so be sure you don't
    already have one you don't want overwritten.
f.) Compile it according to the README
g.) Copy the ora8.so into $NS_HOME/bin
h.) Copy http://photo.net/wtr/thebook/utilities.txt
    to $NS_HOME/modules/tcl/utilities.tcl (note the suffix change)
i.) Rename the $NS_HOME/servers/server1 directory as the name of your
    server (eg: "slicer").
j.) Create a home directory for your server:
    cd $NS_HOME
    mkdir slicer
    cd slicer
    mv ../nsd.tcl .
    rm -rf ../log
    mkdir log
    ln -s ../bin bin
    ln -s ../modules modules
    ln -s ../servers servers
    Create scripts "init" and "kill" as described below
k.) Edit $NS_HOME/slicer/nsd.tcl as described below.
l.) Edit /etc/inittab as described below, and then run "/sbin/init Q" as root.
m.) Place your content:
    global tcl libraries in $NS_HOME/modules/tcl
    site   tcl libraries in $NS_HOME/servers/slicer/modules/tcl
    site   content       in $NS_HOME/servers/slicer/pages


8.) Handy scripts for killing/restarting web servers
--------------------------------------------------------------------------
a.) Here is $NS_HOME/keepalive/init.  It is automatically executed 
by the "init" process on linux whenever the server dies.

#!/bin/bash
# Call this script as root because root runs /sbin/init which restarts
# the server whenever it crashes by calling this script.
# To tell init to run this script, do the following AS ROOT:
# 1.) Edit the /etc/inittab file to add this line:
#     nsp1:2345:respawn:/scratch/ns/keepalive/init
# 2.) At the shell prompt, type "/sbin/init Q"

export NS_HOME=/scratch/ns
export ORACLE_HOME=/scratch/oracle/8i/u01/app/oracle/product/8.1.5
export ORACLE_BASE=/scratch/oracle/8i/u01/app/oracle
export ORACLE_SID=v8i815
export ORA_NLS33=$ORACLE_HOME/ocommon/nls/admin/data
export ORACLE_TERM=vt100
export LD_LIBRARY_PATH=$LD_LIBRARY_PATH:$ORACLE_HOME/lib
export PATH=$PATH:$ORACLE_HOME/bin

$NS_HOME/bin/nsd -it $NS_HOME/keepalive/nsd.tcl -u oracle8i

b.) Here is /scratch/ns/keepalive/kill.  Call this script to kill
the server and let init restart it.  I have the keepalive web server call
a script like this whenever it detects that a web server is hung.

#!/bin/bash
# Call this script as oracle8i
#
$NS_HOME/bin/nsd -Kt $NS_HOME/servers/keepalive/nsd.tcl


9.) How to edit nsd.tcl
--------------------------------------------------------------------------
a.) Change httpport to the port number you wish to connect to.  
To use 80, the server must be executed as root.  To use any other port number,
the URL will become: http://host:port (ie: http://scooby.ai.mit.edu:8000)

b.) Change the servername to the name of the directory in
$NS_HOME/servers (eg: slicer)

c.) Add "index.tcl" to directoryfile so that the main html page can be
served dynamically by a tcl script. 

d.) Add these lines under "ns/parameters":
ns_param StackSize 500000
ns_param mailhost mail.ai.mit.edu

e.) Change this line under "ns/server/${servername}"
ns_param enabletclpages true

f.) Change the port under "ns/server/${servername}/module/nscp"
to a unique number for each of your servers.

g.) Add under "ns/server/${servername}/modules
ns_param tcl Tcl

h.) Add external database driver to connect to oracle:
(An example can be found at:
http://www.arsdigita.com/free-tools/sample-db-ini.txt)

#
# External database driver
#
# NOTE: The MaxIdle and MaxOpen parameters are set here to work
# around a bug exclusive to Linux whereby the connection between
# aolserver and oracle hangs after too many queries.
ns_section "ns/db/drivers"
ns_param ora8 ora8.so

ns_section "ns/db/pool/main"
ns_param Driver ora8
ns_param Connections 4
ns_param DataSource ""
ns_param User SYSTEM
ns_param Password manager
ns_param Verbose On
ns_param ExtendedTableInfo On
ns_param MaxIdle 100000000
ns_param MaxOpen 100000000

ns_section "ns/db/pool/subquery"
ns_param Driver ora8
ns_param Connections 2
ns_param DataSource ""
ns_param User SYSTEM
ns_param Password manager
ns_param Verbose On
ns_param ExtendedTableInfo On
ns_param MaxIdle 100000000
ns_param MaxOpen 100000000

ns_section "ns/db/pool/log"
ns_param Driver ora8
ns_param Connections 2
ns_param DataSource ""
ns_param User SYSTEM
ns_param Password manager
ns_param Verbose On
ns_param ExtendedTableInfo On
ns_param MaxIdle 100000000
ns_param MaxOpen 100000000

ns_section "ns/db/pools"
ns_param main main
ns_param subquery subquery
ns_param log log

ns_section "ns/server/${server}/db"
ns_param Pools *
ns_param DefaultPool main


10.) What to add to .bash_profile
--------------------------------------------------------------------------
#
# aolserver Stuff
#
export NS_HOME=/scratch/ns
export LD_LIBRARY_PATH=$NS_HOME/bin

#
# Oracle Stuff
#
export ORACLE_HOME=/scratch/oracle/8i/u01/app/oracle/product/8.1.5
export ORACLE_BASE=/scratch/oracle/8i/u01/app/oracle
export NLS_LANG='english_united kingdom.we8iso8859p1'
export ORA_NLS33=$ORACLE_HOME/ocommon/nls/admin/data
export ORACLE_TERM=vt100
export LD_LIBRARY_PATH=$LD_LIBRARY_PATH:$ORACLE_HOME/lib
export PATH=$PATH:$ORACLE_HOME/bin
export ORACLE_SID=v8i815

#
# Java
#
export JAVA_HOME=/scratch/jre
export PATH=$JAVA_HOME/bin:$PATH

#
# Slicer
#
export SLICER_DOC=/scratch/web
export CVSROOT=<NOT PUBLIC>

</pre>
